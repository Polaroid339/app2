<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechSolutions TaskManager</title>
    <style>
        :root { --blue: #2563eb; --blue-dark: #1e40af; --bg: #f3f4f6; --white: #fff; --text: #1f2937; --red: #ef4444; --yellow: #f59e0b; }

        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); }

        /* NAVBAR (Menu Superior) */
        nav { background: var(--blue-dark); padding: 1rem; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-brand { font-weight: bold; font-size: 1.2rem; }
        .nav-links button { background: transparent; border: none; color: #bfdbfe; font-size: 1rem; cursor: pointer; margin-left: 15px; padding: 5px 10px; border-radius: 4px; transition: 0.2s; }
        .nav-links button:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-links button.active { color: white; font-weight: bold; background: rgba(255,255,255,0.2); }

        /* LAYOUT CENTRALIZADO PARA LOGIN */
        .auth-container { min-height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card { background: white; padding: 2rem; border-radius: 8px; width: 100%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px;}

        /* INPUTS & BOTOES */
        h2 { color: var(--blue-dark); text-align: center; margin-top: 0; }
        label { display: block; font-size: 0.85rem; color: #4b5563; margin-top: 10px; margin-bottom: 5px; }
        input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 0.75rem; margin-top: 1.5rem; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--blue); color: white; }
        .btn-primary:hover { background: var(--blue-dark); }

        /* UTILIT√ÅRIOS */
        .hidden { display: none !important; }
        .text-link { text-align: center; color: var(--blue); text-decoration: underline; cursor: pointer; font-size: 0.9rem; margin-top: 15px; }
        .error { color: var(--red); text-align: center; font-size: 0.9rem; background: #fee2e2; padding: 10px; border-radius: 4px; display: none; margin-bottom: 10px;}

        /* LISTA DE TAREFAS */
        .page-container { max-width: 800px; margin: 20px auto; padding: 0 20px; }
        .task-card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid var(--blue); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .task-card.completed { border-left-color: #10b981; opacity: 0.6; }
        .task-card.completed h3 { text-decoration: line-through; }

        .task-card.overdue { border-left-color: var(--red); border-right: 1px solid var(--red); background: #fff5f5; }
        .overdue-tag { color: var(--red); font-weight: bold; font-size: 0.75rem; text-transform: uppercase; margin-left: 10px; border: 1px solid var(--red); padding: 2px 5px; border-radius: 4px; }

        .btn-icon { background: #fee2e2; color: var(--red); padding: 5px 10px; border-radius: 4px; cursor: pointer; border:none; margin-left: 10px; }
    </style>
</head>
<body>

    <!-- BARRA DE NAVEGA√á√ÉO (S√≥ aparece se logado) -->
    <nav id="navbar" class="hidden">
        <div class="nav-brand">TechSolutions Tasks</div>
        <div class="nav-links">
            <button id="nav-dash" onclick="goTo('/dashboard')">üìã Minhas Tarefas</button>
            <button id="nav-add" onclick="goTo('/adicionar')">‚ûï Nova Tarefa</button>
            <button onclick="doLogout()" style="color: #fca5a5;">Sair</button>
        </div>
    </nav>

    <!-- P√ÅGINA: LOGIN -->
    <section id="page-login" class="hidden auth-container">
        <div class="card">
            <h2>Bem-vindo de volta</h2>
            <div id="msg-login" class="error"></div>
            <label>Email Acad√™mico</label>
            <input type="email" id="l-email">
            <label>Senha</label>
            <input type="password" id="l-pass">
            <button class="btn btn-primary" onclick="handleLogin()">Entrar na Plataforma</button>
            <div class="text-link" onclick="goTo('/registrar')">Criar uma conta TechSolutions</div>
        </div>
    </section>

    <!-- P√ÅGINA: REGISTRO -->
    <section id="page-register" class="hidden auth-container">
        <div class="card">
            <h2>Criar Conta</h2>
            <div id="msg-reg" class="error"></div>
            <label>Email Acad√™mico</label>
            <input type="email" id="r-email">
            <label>Defina uma senha segura</label>
            <input type="password" id="r-pass">
            <button class="btn btn-primary" onclick="handleRegister()">Cadastrar</button>
            <div class="text-link" onclick="goTo('/login')">J√° tenho conta</div>
        </div>
    </section>

    <!-- P√ÅGINA: DASHBOARD (LISTA) -->
    <section id="page-dashboard" class="hidden page-container">
        <h2 style="text-align: left; margin-bottom: 20px;">Quadro de Atividades</h2>
        <div id="loading" style="text-align:center; color:#666;">Carregando...</div>
        <div id="tasks-list"></div>
    </section>

    <!-- P√ÅGINA: ADICIONAR TAREFA -->
    <section id="page-add" class="hidden page-container">
        <div class="card" style="margin: 0 auto;">
            <h2>Adicionar Tarefa</h2>
            <div id="msg-task" class="error"></div>
            <label>T√≠tulo da Atividade</label>
            <input type="text" id="t-title" placeholder="Ex: Estudar Banco de Dados">

            <label>Data de Vencimento</label>
            <input type="date" id="t-date">

            <button class="btn btn-primary" onclick="handleAddTask()">Salvar Tarefa</button>
            <button class="btn" style="background:#ddd; color:#333; margin-top:10px;" onclick="goTo('/dashboard')">Cancelar</button>
        </div>
    </section>

<script>
    const API_URL = window.location.origin + '/api';
    let TOKEN = null; // A mem√≥ria vol√°til que se apaga no Refresh

    // --- ROTEADOR (SISTEMA DE PAGINAS) ---
    function router() {
        const path = window.location.pathname;

        // Oculta tudo primeiro
        document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
        document.getElementById('navbar').classList.add('hidden');
        document.querySelectorAll('.error').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));

        // Regras de Roteamento
        if (path === '/' || path === '/login') {
            document.getElementById('page-login').classList.remove('hidden');
        }
        else if (path === '/registrar') {
            document.getElementById('page-register').classList.remove('hidden');
        }
        else {
            // Rotas Protegidas (/dashboard, /adicionar)
            if (!TOKEN) {
                // Se tentou acessar p√°gina interna sem token (Deu F5), manda pro login
                goTo('/login');
                return;
            }

            document.getElementById('navbar').classList.remove('hidden');

            if (path === '/dashboard') {
                document.getElementById('page-dashboard').classList.remove('hidden');
                document.getElementById('nav-dash').classList.add('active');
                loadTasks();
            }
            else if (path === '/adicionar') {
                document.getElementById('page-add').classList.remove('hidden');
                document.getElementById('nav-add').classList.add('active');
            }
            else {
                // Rota desconhecida
                goTo('/dashboard');
            }
        }
    }

    // Fun√ß√£o para navegar sem recarregar a p√°gina (Fake Navigation)
    function goTo(path) {
        window.history.pushState({}, "", path);
        router();
    }

    // Captura eventos de voltar/avan√ßar do navegador
    window.onpopstate = router;

    // --- COMUNICA√á√ÉO API ---
    async function api(endpoint, method, body=null) {
        try {
            const headers = { 'Content-Type': 'application/json' };
            if (TOKEN) headers['Authorization'] = `Bearer ${TOKEN}`;

            const res = await fetch(API_URL + endpoint, {
                method, headers, body: body ? JSON.stringify(body) : null
            });

            if(res.status === 401) {
                TOKEN = null;
                alert("Sess√£o expirada");
                goTo('/login');
                return null;
            }
            return res;
        } catch(e) {
            console.error(e);
            return null;
        }
    }

    function showError(elementId, msg) {
        const el = document.getElementById(elementId);
        el.innerText = msg;
        el.style.display = 'block';
    }

    // --- L√ìGICA DO USU√ÅRIO ---
    async function handleLogin() {
        const email = document.getElementById('l-email').value;
        const password = document.getElementById('l-pass').value;

        const res = await api('/login', 'POST', {email, password});
        const data = await res?.json();

        if (res && res.ok) {
            TOKEN = data.access_token;
            // Limpa form
            document.getElementById('l-pass').value = '';
            goTo('/dashboard');
        } else {
            showError('msg-login', data?.msg || "Erro ao conectar");
        }
    }

    async function handleRegister() {
        const email = document.getElementById('r-email').value;
        const password = document.getElementById('r-pass').value;

        const res = await api('/register', 'POST', {email, password});
        const data = await res?.json();

        if (res && res.ok) {
            alert("Sucesso! Fa√ßa Login.");
            goTo('/login');
        } else {
            showError('msg-reg', data?.msg || "Erro no registro");
        }
    }

    function doLogout() {
        TOKEN = null;
        goTo('/login');
    }

    // --- L√ìGICA DE TAREFAS ---
    async function handleAddTask() {
        const title = document.getElementById('t-title').value;
        const date = document.getElementById('t-date').value;

        const res = await api('/tasks', 'POST', {title, due_date: date});

        if (res && res.ok) {
            document.getElementById('t-title').value = '';
            document.getElementById('t-date').value = '';
            goTo('/dashboard'); // Redireciona para p√°gina de listagem
        } else {
            showError('msg-task', "Preencha o t√≠tulo da tarefa");
        }
    }

    async function loadTasks() {
        const container = document.getElementById('tasks-list');
        const loading = document.getElementById('loading');
        loading.classList.remove('hidden');

        const res = await api('/tasks', 'GET');
        const tasks = await res?.json();

        loading.classList.add('hidden');
        container.innerHTML = '';

        if (!tasks || tasks.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#666">Voc√™ est√° livre de tarefas! üöÄ</div>';
            return;
        }

        const today = new Date().toISOString().split('T')[0];

        tasks.forEach(t => {
            const isOverdue = (!t.completed && t.due_date && t.due_date < today);

            // Renderiza o item
            const div = document.createElement('div');
            div.className = `task-card ${t.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}`;

            const dateDisplay = t.due_date ? `üìÖ ${t.due_date.split('-').reverse().join('/')}` : '';
            const overdueHtml = isOverdue ? '<span class="overdue-tag">Atrasado</span>' : '';

            div.innerHTML = `
                <div>
                    <h3 style="margin:0; font-size:1rem; display:flex; align-items:center; gap:10px;">
                        ${t.title} ${overdueHtml}
                    </h3>
                    <small style="color:gray;">${dateDisplay}</small>
                </div>
                <div>
                    <button class="btn-icon" style="background:#e0e7ff; color:var(--blue-dark);" onclick="toggleTask(${t.id}, ${!t.completed})">
                        ${t.completed ? '‚Ü©' : '‚úì'}
                    </button>
                    <button class="btn-icon" onclick="deleteTask(${t.id})">üóë</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function toggleTask(id, status) {
        await api(`/tasks/${id}`, 'PUT', {completed: status});
        loadTasks();
    }

    async function deleteTask(id) {
        if(confirm("Apagar?")) {
            await api(`/tasks/${id}`, 'DELETE');
            loadTasks();
        }
    }

    // Inicializa√ß√£o: L√™ a URL atual e decide qual tela mostrar
    router();

</script>
</body>
</html>
